<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Productos</title>
    <link rel="stylesheet" th:href="@{/productos.css}">
    
    <style>
        /* Estilo suave para productos desactivados */
        .desactivado {
            background-color: rgba(183,75,75,0.06);
            color: #b74b4b;
        }

        .row-actions a, .row-actions form {
            display: inline-block;
            margin-right: 6px;
        }

        /* Buscador */
        #buscador {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #1e1e1e;
            color: white;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 6px;
        }
        .btn:hover {
            background: #2980b9;
        }

        .btn-red {
            padding: 8px 14px;
            background: #c0392b;
            color: white;
            border-radius: 6px;
            text-decoration: none;
        }
    </style>
</head>

<body>
<div class="card">

    <h1>Lista de Productos</h1>

    <!-- ================================
            MENSAJES DE √âXITO/ERROR
    ==================================== -->
    <div th:if="${mensaje}" style="background: #d4edda; color: #155724; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #c3e6cb;">
        ‚úì <span th:text="${mensaje}"></span>
    </div>
    <div th:if="${error}" style="background: #f8d7da; color: #721c24; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #f5c6cb;">
        ‚úó <span th:text="${error}"></span>
    </div>

    <!-- ================================
            BOTONES SUPERIORES
    ==================================== -->
    <div class="header-actions">
        <!-- Solo Admin (rol=1) puede agregar productos -->
        <a th:if="${session.empleadoLogueado.rolId == 1}" th:href="@{/producto/nuevo}" class="btn">‚ûï Agregar Producto</a>
        <a th:href="@{/home}" class="btn">üè† Volver al Home</a>
    </div>

    <!-- ================================
             BUSCADOR JS
    ==================================== -->
    <input type="text" id="buscador" placeholder="Buscar producto...">

    <!-- ================================
            CARGAR CSV (solo admin)
    ==================================== -->
    <form th:if="${empleadoLogueado != null and empleadoLogueado.rolId == 1}" 
          th:action="@{/producto/cargar-csv}" 
          method="post" enctype="multipart/form-data">
        <input type="file" name="archivo" accept=".csv" required>
        <button type="submit">Cargar productos desde CSV</button>
    </form>

    <!-- ================================
            TABLA DE PRODUCTOS
    ==================================== -->
    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Proveedores</th>
            <th>Estado</th>
            <th>cvv</th>
            <th>Exento</th>
            <th>Ganancia</th>
            <th>Precio</th>
            <th>Precio Base</th>
            <th>Acciones</th>
            <th>Descripci√≥n</th>
        </tr>
        </thead>

        <tbody id="tablaProductos">

        <tr th:each="producto : ${productos}"
            th:attr="data-nombre=${producto.nombre}"
            th:classappend="${producto.activo} ? '' : 'desactivado'">

            <td th:text="${producto.id}"></td>

            <td th:text="${producto.nombre}"></td>

            <!-- Proveedores -->
            <td>
                <span th:if="${#lists.isEmpty(producto.proveedores)}">‚Äî</span>
                <span th:each="prov, i : ${producto.proveedores}">
                    <span th:text="${prov.nombre}"></span><span th:if="${!i.last}">, </span>
                </span>
            </td>

            <td th:text="${producto.activo ? 'Activo' : 'Deshabilitado'}"></td>

            <td th:text="${producto.cvv != null ? producto.cvv : '-'}"></td>

            <td th:text="${producto.exento ? 'S√≠' : 'No'}"></td>

            <td th:text="${producto.ganancia != null ? #numbers.formatDecimal(producto.ganancia, 1, 'POINT', 2, 'COMMA') : '-'}"></td>

            <td th:text="${producto.precio != null ? #numbers.formatDecimal(producto.precio, 1, 'POINT', 2, 'COMMA') : '-'}"></td>

            <td th:text="${producto.precioBase != null ? #numbers.formatDecimal(producto.precioBase, 1, 'POINT', 2, 'COMMA') : '-'}"></td>

            <!-- ACCIONES - Solo Admin (rol=1) -->
            <td class="row-actions" th:if="${session.empleadoLogueado.rolId == 1}">
                <a th:href="@{|/producto/editar/${producto.id}|}" class="btn">Editar</a>

                <a th:href="@{|/producto/eliminar/${producto.id}|}"
                   class="btn-red"
                   onclick="return confirm('¬øEliminar producto?');">
                    Eliminar
                </a>
            </td>
            <!-- Para Cajero (rol=2), solo lectura -->
            <td th:unless="${session.empleadoLogueado.rolId == 1}" style="color: #999; font-style: italic;">
                [Solo lectura]
            </td>

            <td th:text="${producto.descripcion}"></td>
        </tr>

        </tbody>
    </table>

</div>


<!-- ==================================
        JAVASCRIPT DEL BUSCADOR
===================================== -->
<script>
    const buscador = document.getElementById("buscador");
    const filas = document.querySelectorAll("#tablaProductos tr");

    buscador.addEventListener("input", function () {
        const texto = this.value.toLowerCase();

        filas.forEach(fila => {
            let nombre = fila.getAttribute("data-nombre").toLowerCase();
            fila.style.display = nombre.includes(texto) ? "" : "none";
        });
    });
</script>

</body>
</html>
