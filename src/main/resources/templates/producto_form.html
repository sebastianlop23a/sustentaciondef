<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${producto.id} == null ? 'Nuevo Producto' : 'Editar Producto'"></title>
    <link rel="stylesheet" th:href="@{/productos.css}">
    <style>
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 22px; margin-top: 25px; }
        .form-box { background: rgba(255,255,255,0.02); padding: 22px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); }
        .form-box h3 { margin-bottom: 12px; font-size: 20px; }
        .form-box label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: bold; }
        .form-box input, .form-box textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1e1e1e; color: white; }
        textarea { height: 110px; resize: none; }
        .proveedores-box { background: rgba(255,255,255,0.03); padding: 18px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .checkbox-label { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
        .submit-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 25px; }
        .btn { padding: 10px 18px; border-radius: 8px; text-decoration: none; border: none; cursor: pointer; font-weight: bold; }
        .btn-save { background: #27ae60; color: white; }
        .btn-cancel { background: #555; color: white; }
        .btn-delete { background: #c0392b; color: white; }
    </style>
</head>
<body>

<div class="card">
    <h1 th:text="${producto.id} == null ? 'Nuevo Producto' : 'Editar Producto'"></h1>

    <form id="productoForm" th:action="@{/producto/guardar}" method="post">
        <input type="hidden" th:if="${producto.id != null}" name="id" th:value="${producto.id}">
        <input type="hidden" name="activo" id="activoField" th:value="${producto.activo}">

        <div class="form-grid">
            <!-- IZQUIERDA -->
            <div class="form-box">
                <h3>Información del Producto</h3>

                <label>Nombre</label>
                <input type="text" name="nombre" th:value="${producto.nombre}" required>

                <label>Precio Base (Costo)</label>
                <input type="text"
                       id="precioBaseInput"
                       name="precioBase"
                       placeholder="0,00"
                       th:value="${producto.precioBase != null ? #numbers.formatDecimal(producto.precioBase, 0, 'POINT', 2, 'COMMA') : ''}"
                       required>

                <label>Precio de Venta</label>
                <input type="text"
                       id="precioVentaInput"
                       name="precio"
                       placeholder="0,00"
                       th:value="${producto.precio != null ? #numbers.formatDecimal(producto.precio, 0, 'POINT', 2, 'COMMA') : ''}"
                       required>

                <label>Ganancia (Automática)</label>
                <input type="text"
                       id="gananciaInput"
                       name="ganancia"
                       placeholder="0,00"
                       readonly
                       th:value="${producto.ganancia != null ? #numbers.formatDecimal(producto.ganancia, 0, 'POINT', 2, 'COMMA') : '0,00'}"
                       style="background:#333;">
            </div>

            <!-- DERECHA -->
            <div class="form-box">
                <h3>Descripción & Proveedores</h3>

                <label>Descripción</label>
                <textarea name="descripcion" th:text="${producto.descripcion}"></textarea>

                <div class="proveedores-box">
                    <h4>Proveedores</h4>
                    <div th:each="prov : ${proveedores}">
                        <label class="checkbox-label">
                            <input type="checkbox"
                                   name="proveedorIds"
                                   th:value="${prov.id}"
                                   th:checked="${producto.proveedores != null && producto.proveedores.contains(prov)}">
                            <span th:text="${prov.nombre}"></span>
                        </label>
                    </div>
                    <p th:if="${#lists.isEmpty(proveedores)}">
                        No hay proveedores.
                        <a th:href="@{/proveedores/nuevo}">Agregar uno</a>
                    </p>
                </div>
            </div>
        </div>

        <div class="submit-actions">
            <button type="submit" class="btn btn-save">Guardar</button>
            <a th:href="@{/producto}" class="btn btn-cancel">Cancelar</a>
            <a th:if="${producto.id != null}"
               th:href="@{|/producto/eliminar/${producto.id}|}"
               class="btn btn-delete"
               onclick="return confirm('¿Eliminar producto?')">Eliminar</a>
        </div>
    </form>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
function parseColombian(n) { return n.replace(/\./g, "").replace(",", "."); }

document.addEventListener("input", function () {
    const base = document.getElementById("precioBaseInput");
    const venta = document.getElementById("precioVentaInput");
    const ganancia = document.getElementById("gananciaInput");

    if (!base || !venta || !ganancia) return;

    const nb = parseFloat(parseColombian(base.value)) || 0;
    const nv = parseFloat(parseColombian(venta.value)) || 0;

    ganancia.value = (nv - nb).toLocaleString("es-CO", { minimumFractionDigits: 2 });
});
/*]]>*/
</script>

</body>
</html>
