<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Registrar Venta</title>
    <link rel="stylesheet" th:href="@{/registrar.css}">
    
    <style>

   /* ============================= */
/* GLOBAL */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background: linear-gradient(160deg, #0f0f0f, #1a1a1a);
    color: #fff;
    padding: 20px;
}

/* ============================= */
/* BUSCADOR */
#buscador {
    width: 100%;
    padding: 14px 18px;
    margin-bottom: 30px;
    border-radius: 12px;
    border: none;
    background-color: #222;
    color: #fff;
    font-size: 16px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    transition: all 0.3s ease;
}

#buscador:focus {
    outline: none;
    box-shadow: 0 0 15px #3498db;
    background-color: #1a1a1a;
}

/* ============================= */
/* SLIDER PRODUCTOS */
.productos-slider {
    display: flex;
    align-items: center;
    gap: 15px;
    position: relative;
}

.slider-arrow {
    background-color: #3498db;
    color: #fff;
    border: none;
    border-radius: 50%;
    padding: 12px 15px;
    cursor: pointer;
    font-size: 26px;
    transition: all 0.3s ease;
    z-index: 10;
}

.slider-arrow:hover {
    transform: scale(1.2);
    background-color: #27ae60;
}

.grid-productos {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding: 10px 0;
    scroll-snap-type: x mandatory;
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.grid-productos::-webkit-scrollbar {
    display: none;
}

/* ============================= */
/* TARJETAS PRODUCTO */
.card-producto {
    flex-shrink: 0;
    width: 220px;
    background: linear-gradient(145deg, #1e1e1e, #2c2c2c);
    border-radius: 15px;
    border: 1px solid #333;
    padding: 15px;
    scroll-snap-align: start;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.3s ease;
    position: relative;
}

.card-producto:hover {
    transform: scale(1.08) rotate(-1deg);
    box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    border-color: #3498db;
}

.prod-info h4 {
    font-size: 18px;
    margin-bottom: 6px;
    text-align: center;
    color: #fff;
}

.prod-info .stock,
.prod-info .precio,
.prod-info .estado {
    font-size: 13px;
    color: #bbb;
    margin: 3px 0;
    text-align: center;
}

.btn-add {
    margin-top: 12px;
    background: #e67e22;
    color: #fff;
    border: none;
    padding: 10px 15px;
    border-radius: 50px;
    cursor: pointer;
    font-weight: bold;
    width: 100%;
    transition: all 0.3s ease;
}

.btn-add:hover {
    background: #d35400;
    transform: scale(1.05);
}

/* ============================= */
/* CARRITO FLOTANTE */
#carrito {
    position: fixed;
    right: 20px;
    top: 100px;
    width: 300px;
    background-color: #1b1b1b;
    border-radius: 15px;
    padding: 20px;
    border: 1px solid #333;
    box-shadow: 0 10px 25px rgba(0,0,0,0.7);
    max-height: 70vh;
    overflow-y: auto;
    z-index: 20;
    transition: all 0.3s ease;
}

#carrito h3 {
    margin-bottom: 15px;
    text-align: center;
    color: #3498db;
    font-size: 20px;
}

.carrito-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #2a2a2a;
    border-radius: 12px;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #444;
    transition: all 0.2s ease;
}

.carrito-item:hover {
    background: #333;
}

.carrito-item input[type="number"] {
    width: 50px;
    padding: 6px;
    border-radius: 8px;
    border: 1px solid #555;
    background-color: #121212;
    color: #fff;
}

.btn-remove {
    background-color: #c0392b;
    border: none;
    color: #fff;
    padding: 5px 8px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-remove:hover {
    background-color: #e74c3c;
    transform: scale(1.2);
}

.submit-row {
    display: flex;
    justify-content: center;
    margin-top: 15px;
}

.submit-row button {
    padding: 10px 20px;
    border-radius: 50px;
    border: none;
    background: #27ae60;
    font-weight: bold;
    cursor: pointer;
    color: #fff;
    transition: all 0.3s ease;
}

.submit-row button:hover {
    background: #2ecc71;
    transform: scale(1.05);
}

/* ============================= */
/* RESPONSIVE */
@media (max-width: 1200px) {
    .card-producto { width: 200px; }
    #carrito { width: 260px; }
}

@media (max-width: 900px) {
    .card-producto { width: 180px; }
    #carrito { width: 240px; top: 80px; }
}

@media (max-width: 700px) {
    .card-producto { width: 150px; }
    #carrito { width: 220px; top: 60px; }
}

@media (max-width: 500px) {
    .productos-slider {
        flex-direction: column;
    }
    .slider-arrow {
        align-self: center;
    }
    .card-producto { width: 100%; min-width: 0; }
    #carrito {
        width: 90%;
        top: auto;
        bottom: 20px;
        right: 50%;
        transform: translateX(50%);
        max-height: 50vh;
    }
}


    </style>
</head>

<body>

<div class="card">

    <a th:href="@{/home}" class="btn-home">Volver al Home</a>
    <h2>Registrar Nueva Venta</h2>

    <form th:action="@{/ventas/registrar}" method="post" id="formVenta">

        <input type="text" id="buscador" placeholder="Buscar producto...">


        <h3>Productos Disponibles</h3>

        <div class="productos-slider">
            
            <button type="button" class="slider-arrow" id="arrowLeft" onclick="scrollLeft()">&#10094;</button>

            <div class="grid-productos" id="listaProductos">

                <div class="card-producto" 
                     th:each="inv : ${inventarios}"
                     th:attr="data-nombre=${inv.producto.nombre}"
                     th:data-producto-id="${inv.id}"> <div class="prod-info">
                        <h4 th:text="${inv.producto.nombre}">Nombre</h4>

                        <p class="stock">Stock: <span th:text="${inv.cantidad}">0</span></p>

                        <p class="precio">
                          $ <span th:text="${#numbers.formatDecimal(inv.producto.precio, 0, 'COMMA', 2, 'POINT')}">0,00</span>
                        </p>

                        <p class="estado"
                           th:text="${inv.producto.activo ? 'Activo' : 'Deshabilitado'}"
                           th:style="${inv.producto.activo ? 'color:#6bc46b' : 'color:#e74c3c'}">
                        </p>

                        <button type="button" class="btn-add"
                                th:attr="onclick=|agregarAlCarrito('${inv.id}', '${inv.producto.nombre}', '${inv.cantidad}', '${inv.producto.precio}', '${inv.producto.activo}')|">
                            Agregar
                        </button>
                    </div>
                </div>

            </div>
            
            <button type="button" class="slider-arrow" id="arrowRight" onclick="scrollRight()">&#10095;</button>

        </div>


        <h3>Productos Seleccionados</h3>

        <div id="carrito">
            <p id="carritoVacio">No hay productos seleccionados.</p>
        </div>


        <div class="form-row">
            <label for="clienteId">Cliente registrado (opcional):</label>
            <select id="clienteId" name="clienteId" style="width:100%;">
                <option value="">-- Cliente existente --</option>
                <option th:each="cli : ${clientes}" th:value="${cli.id}" th:text="${cli.nombre}">Cliente</option>
            </select>
        </div>

        <div class="form-row form-row-inline">
            <div style="flex:1;">
                <label for="cliente">Cliente (nombre libre):</label>
                <input type="text" id="cliente" name="cliente" placeholder="Nombre del cliente">
            </div>

            <button type="button" onclick="window.open('/clientes/nuevo','_blank')" style="margin-top:22px;">
                Registrar cliente
            </button>
        </div>

        <div class="form-row">
            <label>Documento:</label>
            <input type="text" name="clienteDocumento" maxlength="10" 
                        oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)">
        </div>

        <div class="form-row">
            <label>Teléfono:</label>
            <input type="text" name="clienteTelefono" maxlength="10" 
                        oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)">
        </div>

        <div class="form-row">
            <label>Dirección:</label>
            <input type="text" name="clienteDireccion">
        </div>

        <div class="form-row">
            <label for="metodoPago">Método de pago:</label>
            <select id="metodoPago" name="metodoPago" required>
                <option value="Efectivo">Efectivo</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Transferencia">Transferencia</option>
            </select>
        </div>

        <div class="submit-row">
            <button type="submit" class="btn-success">Registrar Venta</button>
        </div>

    </form>
</div>




<script>

let carrito = [];
const listaProductos = document.getElementById('listaProductos');

// La cantidad de desplazamiento es el ancho de una tarjeta más el gap
function getScrollAmount() {
    // Tomamos la primera tarjeta para medir su ancho
    const firstCard = listaProductos.querySelector('.card-producto');
    if (!firstCard) return 0;
    
    const cardWidth = firstCard.offsetWidth;
    // El gap se definió en 20px en el CSS
    const gap = 20; 
    
    // Desplazamos por la mitad del ancho visible (ej. 2.5 productos) para que sea suave y cubra el centro
    // o simplemente un ancho completo (1 producto) para mayor precisión.
    return cardWidth + gap; 
}


/* ==============================
   SCROLL HACIA LA DERECHA (NUEVO)
============================== */
function scrollRight() {
    const scrollAmount = getScrollAmount() * 2; // Desplazamos 2 tarjetas a la vez
    // Usamos scrollBy para desplazamiento relativo (con animación smooth del CSS)
    listaProductos.scrollBy({
        left: scrollAmount, 
        behavior: 'smooth'
    });
}

/* ==============================
   SCROLL HACIA LA IZQUIERDA (NUEVO)
============================== */
function scrollLeft() {
    const scrollAmount = getScrollAmount() * 2; // Desplazamos 2 tarjetas a la vez
    // Usamos scrollBy para desplazamiento relativo (con animación smooth del CSS)
    listaProductos.scrollBy({
        left: -scrollAmount, 
        behavior: 'smooth'
    });
}


/* ==============================
   AGREGAR PRODUCTO AL CARRITO
   (Mantenemos la lógica intacta)
============================== */
function agregarAlCarrito(id, nombre, stock, precio, activo) {

    stock = parseInt(stock);
    precio = parseFloat(precio);
    activo = ('' + activo) === 'true' || ('' + activo) === 'True';

    if (!activo) {
        alert("❌ Este producto está deshabilitado.");
        return;
    }

    if (stock <= 0) {
        alert("❌ No hay stock disponible.");
        return;
    }

    let existente = carrito.find(p => p.id === id);

    if (existente) {
        if (existente.cantidad + 1 > stock) {
            alert("❌ No puedes agregar más de lo disponible.");
            return;
        }
        existente.cantidad++;
    } else {
        carrito.push({
            id: id,
            nombre: nombre,
            stock: stock,
            precio: precio,
            cantidad: 1
        });
    }

    renderCarrito();
}


/* ==============================
   MOSTRAR CARRITO
   (Mantenemos la lógica intacta)
============================== */
function renderCarrito() {

    const cont = document.getElementById("carrito");
    cont.innerHTML = "";

    if (carrito.length === 0) {
        cont.innerHTML = "<p id='carritoVacio'>No hay productos seleccionados.</p>";
        return;
    }

    carrito.forEach((p, index) => {
        const totalLinea = (p.precio * p.cantidad).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        cont.innerHTML += `
            <div class="carrito-item">
                <div>
                    <strong>${escapeHtml(p.nombre)}</strong><br>
                    <small>Cantidad máx: ${p.stock}</small>
                </div>

                <input type="number"
                        min="1"
                        max="${p.stock}"
                        value="${p.cantidad}"
                        onchange="cambiarCantidad(${index}, this.value)">

                <button type="button" class="btn-remove" onclick="eliminar(${index})">X</button>

                <input type="hidden" name="inventarioId" value="${p.id}">
                <input type="hidden" name="cantidad" value="${p.cantidad}" class="cantidad-hidden-${index}">
            </div>
        `;
    });
}

/* ==============================
   ESCAPE simple para evitar HTML injection en nombres
============================== */
function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
}

/* ==============================
   CAMBIAR CANTIDAD
   (Mantenemos la lógica intacta)
============================== */
function cambiarCantidad(index, nueva) {
    nueva = parseInt(nueva);

    if (isNaN(nueva) || nueva < 1) {
        alert("Cantidad inválida.");
        renderCarrito();
        return;
    }

    if (nueva > carrito[index].stock) {
        alert("❌ No puedes exceder el stock.");
        renderCarrito();
        return;
    }

    carrito[index].cantidad = nueva;
    renderCarrito();
}

/* ==============================
   ELIMINAR DEL CARRITO
   (Mantenemos la lógica intacta)
============================== */
function eliminar(index) {
    carrito.splice(index, 1);
    renderCarrito();
}

/* ==============================
   VALIDACIÓN FINAL PARA EVITAR 400
   (Mantenemos la lógica intacta)
============================== */
document.getElementById("formVenta").addEventListener("submit", function(e) {

    if (carrito.length === 0) {
        e.preventDefault();
        alert("❌ Debes seleccionar al menos 1 producto.");
        return;
    }

    for (let p of carrito) {
        if (p.cantidad < 1 || p.cantidad > p.stock) {
            e.preventDefault();
            alert("❌ Cantidad inválida en uno de los productos.");
            return;
        }
    }
});


/* ==============================
   BUSCADOR DE PRODUCTOS (MODIFICADO para SLIDER)
   - Ahora oculta y muestra los elementos, pero la navegación
     por flechas sigue moviendo el contenedor completo.
============================== */
document.getElementById("buscador").addEventListener("input", function() {
    let texto = this.value.toLowerCase();
    let cards = listaProductos.querySelectorAll(".card-producto");

    cards.forEach(card => {
        let nombre = (card.getAttribute("data-nombre") || "").toLowerCase();
        
        // El buscador simplemente oculta/muestra la tarjeta
        card.style.display = nombre.includes(texto) ? "block" : "none";
    });
    
    // Si la búsqueda cambia, es bueno hacer un scroll al inicio
    listaProductos.scrollLeft = 0;
});


// Inicializa el render del carrito
document.addEventListener('DOMContentLoaded', renderCarrito);

</script>

</body>
</html>